# AiStackChanEx

## Ver1.05 2023-05-16

Extended from

//  M5Unified_StackChan_ChatGPT : 2023-04-16(Ver007) Robo8080さん

//  AI-StackChan-GPT-Timer      : 2023-04-07         のんちらさん

//  ai-stack-chan_wifi-selector : 2023-04-22         ひろきち821さん

------------------------------------------------------------------------

### （１）固定IP対応　 Wifi接続

　"wifi-select.json" 設定ファイルに固定IPモードの情報を追加し、今までのDHCPに加えて、固定IPでのwifi接続に対応しました。


```json
{
  "timeout": 10,
  "accesspoint":
  [
    {
      "ssid": "AP00",
      "passwd": "PSWD00",
      "ip": "192.168.0.100",
      "gateway": "192.168.0.1",
      "subnet": "255.255.255.0",
      "dns": "192.168.0.1"
},
    {
      "ssid": "AP01-iPhone",
      "passwd": "PSWD11",
      "ip": "172.20.10.2",
      "gateway": "172.20.10.1",
      "subnet": "255.255.255.240",
      "dns": ""
},
    {
      "ssid": "AP02",
      "passwd": "PSWD22",
      "ip": "",
      "gateway": "",
      "subnet": "",
      "dns": ""
}
  ]
}
```

Phoneテザリングは、固定IPを使えると便利であるとの情報を得ました。
iPhoneテザリングの場合の固定IP設定例は、上記２番目のssid="AP01-iPhone"です。

（ssid="AP01-iPhone" の例、IPは、172.20.10.2～172.20.10.14 の範囲）


なお、固定IPを使う場合には、ssid,passwd,ip,gateway,subnetの情報は必須事項。dnsはオプションです。

ip情報がなければ今までと同じDHCPで接続します。DHCPの場合には、ssid,passwdの情報が必須事項となります。



### （２）「わかりません対策２」

SPIFFS内にある chat_doc用のファイル"/data.json"ファイルが破損していた場合に「わかりません」を連続する
状況に対応しました。

・ファイルが壊れている場合には、ソフト内で初期情報を書き込む処理。

・上記で対策はできると思っていますが、もし３連続で「わかりません。」が起きたときにも、初期情報を書き込む処理を追加。


・それでも、「わかりません」が発生した場合に備え、従来の「わかりません」を変更してエラー番号とコードを話すようにしました。

-------------------------------------------------------------------------------

*★　「　わかりません、番号 xx、コード xxx です。　」　*

コードは、httpsCode(サーバーからの戻り値)　コードがあるのは、エラー番号が１、２，３番号の時です。４，５番はありません。


エラー番号は、https_post_json()関数内で定義している、次の１～５番です。


１. httpsからのエラーはなかったが、文字が入っていなかった。

　  "CODE_OK or CODE_MOVED_PERMANENTLY and payload is void "

２. httpsCodeがエラーを返した。  "httpCode other error code number get "

３. https POSTに失敗。  "HTTPS POST... failed"

４. httpsの接続に失敗。   "HTTPS　Unable to connect"

５. httpsクライアントになれない。  "Unable to create client"

★　そのほかにも可能性としては、ChatGPTが正常に応答し、「わかりません」の文字を発行した場合には、
番号なしで、ただ「わかりません」と発音する可能性があります。


-------------------------------------------------------------------------------



### （３）．ロール設定を１個限定の対応（外部インターフェースのみ）

実験的な内容となりますが、従前のroleコマンドは、role-system-contentを複数作成できて、全てChatGPTに送信していますが
今回、１個だけに限定するものを用意しました。使い方はほぼ同じですが、違いは、複数個のrole-system-contentは作らないで、
１個限定になります。何も情報を入れない場合は、初期情報を入れて、必ずロール情報は１個だけ存在するようにしました。

★ なお、従来のロール設定のコマンドを使用した場合には、従来の動作のまま動作しますので影響はないです。


※IPアドレスを「192.168.0.100」として記述していますが、各自読み替えてください。

APは、accessPointの略。



### <使用方法>　　外部インターフェース

-------------------------------------

*〇 wifi-select 設定　（固定IPモード対応）*


http://192.168.0.100/wifiSelect?ssid=AP00&passwd=PSWD00&ip=192.168.0.100&gateway=192.168.0.1&subnet=255.255.255.0&dns=192.168.0.1

（ssid,passwd,ip,gateway,subnet,dns情報を登録して、固定IPモードで接続情報を登録。）

http://192.168.0.100/wifiSelect?ssid=AP01&passwd=PSWD11&ip=192.168.0.100&gateway=192.168.0.1&subnet=255.255.255.0

（DNS情報を使用しないで、固定IPモードで接続する場合。）

http://192.168.0.100/wifiSelect?init=on&ssid=AP00&passwd=PSWD00&ip=192.168.0.100&gateway=192.168.0.1&subnet=255.255.255.0&dns=192.168.0.1

（initコマンド使うと、初期化後に優先順位一番のデータだけを作れます。）


http://192.168.0.100/wifiSelect?ssid=AP02&passwd=PSWD22

(従来のDHCPモードで使う場合は、ssid と　passwd の情報を指定します。)

次のコマンドを使って確認と再起動を行います。

http://192.168.0.100/wifiSelect 　　　　　 （設定ファイルの内容確認）


http://192.168.0.100/shutdown?reboot=on     （シャットダウン後にリブート）



*〇ロール１情報の作成*

１個限定の　role-system-content を作成します。何も入力した場合には、ロール設定を初期情報にします。
今までの、roleの替わりに使用できます。

http://192.168.0.100/role1     (ロール情報を１個限定で作成)


ロール情報の確認は、従来のコマンドを使用ください。

http://192.168.0.100/role_get     (ロール情報確認)



------------------------------------------------------------------------



## Ver1.04 2023-05-09


### （１）．ひろきち８２１さんのソフトをもとに複数のwifiアクセスポイントを設定し、接続できるAPを探す機能を追加しました。
(以下、wifi-Selectと呼びます。)

SDカードの直下の下記フォーマットの "wifi-select.json" 設定ファイルに従って上の方APから順番に接続を試していきます。


```json
{
  "timeout": 10,
  "accesspoint":
  [
    {
      "ssid": "AP00SSID",
      "passwd": "PSWD0000"
    },
    {
      "ssid": "AP11SSID",
      "passwd": "PSWD1111"
    },
    {
      "ssid": "AP22SSID",
      "passwd": "PSWD2222"
    }
  ]
}
```

他のwifi接続方法との関係ですが、接続順位は、次の用になっています。有効な設定・情報があればwifi接続を試していきます。

"wifi-select.json"設定　＞　 "wifi.txt"設定　＞　前回のwifi接続情報 ＞　SmartConfig接続

設定ファイルは、メモ帳等で作成＆SD直下に保存するか、外部インターフェースで作成してください。



*★★★　例：wifi-select機能を利用した外出先wifiへの接続手順　★★★*

-------------------------------------------------------------------------------------

１．通常は、優先順位１番に自宅wifiAP設定、優先順位２番にスマホのテザリング用AP設定を登録して使用する。

２．外出先では、スタックチャンをスマホのテザリングで繋いで、優先順位３番に外出先wifiのAP設定を登録する。

３．rebootして、その間にスマホのテザリング切ると、スタックチャンは外出先wifiに繋がります。

　スマホも外出先wifiに繋げて、スタックチャンのIPアドレスを設定すれば外出先wifiでの接続は完了です。

　（スタックチャンのボタンＣを押下するといつでも「ＩＰアドレス」情報を見ることができます。）

４．自宅に戻って、不要になった外出先AP情報は、removeで削除することができます。

-------------------------------------------------------------------------------------


### （２）． 外部インターフェースでは、次の追加をしました。

　・wifi-select設定

　・shutdown/reboot機能

　・toneMode機能　　　　

　・システム情報の個別送信の対応



### （３）．トミロさんから情報をいただいた「わかりません」対策。

 httpsタイムアウト値 と VoiceTextのレスポンスdelay時間 を調整しました。　






### <使用方法>　　外部インターフェース

-------------------------------------

※※※※　Ver1.05 で　固定IPモード対応になったのでそちらを参照 ※※※※

〇 wifi-select 設定

※※※　Ver1.05 で固定IPモード対応になったので、そちらも参照 ※※※


SD直下の設定ファイル "wifi-select.json"を表示、修正できます。

http://192.168.0.100/wifiSelect
（ 設定ファイルの内容表示　）


http://192.168.0.100/wifiSelect?init=on 
（　設定ファイル作成・初期化。AP情報は全て削除されます。 ）


http://192.168.0.100/wifiSelect?ssid=AP22SSID&passwd=PSWD2222 

( ssid=AP22SSID,  passwd=PSWD2222 でAPを追加。優先順位は最後尾に追加されます。)


http://192.168.0.100/wifiSelect?remove=1 

(　優先度２番目のAP情報を削除。　番号は「0」から開始します。「0」は最高優先のAP。)　


http://192.168.0.100/wifiSelect?init=on&ssid=AP00SSID&passwd=PSWD0000

( 初期化後に、ssid=AP00SSID,  passwd=PSWD0000 でAP情報を新規作成。)

SDに"wifi-select.json" が存在しない場合でも、上記コマンドで最初のAP情報を登録でます。


※　設定変更した情報で wifi を再接続させるには、スタックチャンのリブートが必要になります。

下記のコマンドを使用することができます。



〇 shutdown/reboot 機能

http://192.168.0.100/shutdown              （シャットダウン）

http://192.168.0.100/shutdown?time=10      （１０秒後にシャットダウン）

http://192.168.0.100/shutdown?reboot=on     （シャットダウン後にリブート）

http://192.168.0.100/shutdown?reboot=on&time=15  （１５秒後にシャットダウン＆リブート）

time は、( 2 - 60 )秒まで設定できます。




〇 toneMode機能

外部で音声認識される場合にトーン音が邪魔になる場合がありましたので、この機能を設けました。

４種類のtoneModeを選ぶことができます。初期値は、toneMode=1 です。

http://192.168.0.100/setting?toneMode=0   （トーン音なし）

http://192.168.0.100/setting?toneMode=1 （初期値：ボタン押下時のみトーン音）

http://192.168.0.100/setting?toneMode=2
（外部コマンド受信時のみトーン音）

http://192.168.0.100/setting?toneMode=3
（ボタン押下時および外部コマンド受信時）




〇 システム情報の個別送信

V103のシステム情報を個別に送信できるようにしました。

http://192.168.0.100/sysInfo?tx=version

（ V101の「version」と同じ機能です。V101版のコマンドは次回廃止予定。）


http://192.168.0.100/sysInfo?tx=IP_Addr


http://192.168.0.100/sysInfo?tx=batteryLevel


http://192.168.0.100/sysInfo?tx=volume


http://192.168.0.100/sysInfo?tx=timer


http://192.168.0.100/sysInfo?tx=mute


http://192.168.0.100/sysInfo?tx=randomSpeak


http://192.168.0.100/sysInfo?tx=uptime


http://192.168.0.100/sysInfo?tx=toneMode


http://192.168.0.100/sysInfo?tx=SSID_PASSWD


http://192.168.0.100/sysInfo?tx=OPENAI_API_KEY


http://192.168.0.100/sysInfo?tx=VOICETEXT_API_KEY



※　現在、M5Stack Core2 for AWS 本体のみ、PC(win11)、Androidスマホで開発をおこなっています。
チェックしきれないことがあるかもしれませんが、ご了承ください。
不具合等が発生している場合にはご連絡ください。早急に対応するつもりです。


------------------------------------------------------------------------

## Ver1.03 2023-05-02


### １．システム情報表示

ボタンＣ(右側)で 画面に表示します。外部インターフェースも設けています。
画面表示中は、Mute On（無音）状態となります。タイマーや独り言モードモードも解除します。
ボタンＣを押した場合は、トグルで On/Off の状態が変わります。
表示内容は、<使用方法>の箇所を参照してください。


### ２．音声Mute On/Off 機能

外部インターフェースで、 音声Mute On/Offの制御ができます。
なお、画面にシステム情報が表示されているときは、自動的にMute On（無音）状態にしています。



### ３．タイマーの時間設定に問題がありましたので修正しました。


※IPアドレスを「192.168.0.100」として記述していますが、各自読み替えてください。



### <使用方法>

-------------------------------------


〇 System Information

：システム情報を外部に出力する。 (mode=0)

http://192.168.0.100/sysInfo

http://192.168.0.100/sysInfo?mode=0

ボタンＣを押下して表示される情報を外部に出力します。

Version, IP_ADDR, SSID, BatteryLevel, Volume, Timer, 
Mute_OnOff, RandomSpeak_OnOff, Uptime(起動時間)



：ネットワーク設定を出力する。(mode=1)

http://192.168.0.100/sysInfo?mode=1


IP_ADDR, SSID,SSID_PASSWD, OPEN_API_KEY, VOCETEXT_API_KEY




画面にも同時に表示することができます。

http://192.168.0.100/sysInfo?disp=on

http://192.168.0.100/sysInfo?mode=0&disp=on

http://192.168.0.100/sysInfo?mode=1&disp=on




画面の表示を消去する。

http://192.168.0.100/sysInfo?disp=off




〇 Mute On （消音状態）

http://192.168.0.100/setting?mute=on



〇 Mute Off　（volume値を復帰し、音声が有効な通常の状態）

http://192.168.0.100/setting?mute=off


＊ 制限事項　＊

・システム情報を表示中は、「独り言モード」と「タイマー」両方の機能は解除されます。

・「独り言モード」動作中に、「タイマー」開始すると「独り言モード」は解除します。

・「タイマー」動作中に、「独り言モード」を開始すると、「タイマー」は解除します。

------------------------------------------------------------------------

## Ver1.02 2023-04-24

### １．ボタンＡ、Ｃの機能に対応する外部インターフェースを設けました。
Ver1.01 でボタンＢの機能に対応していますので、ボタン操作なしで、本体をケースに
入れた場合や離れた場所からのスタックチャンの操作が可能になります。

### ２．ソースをコンパイルする時に出ていた warningを解消しました。

 [warning対策01]～[warning対策03]とソースのコメント内に記述しました。




### <使用方法>

-------------------------------------

〇randomSpeak (ボタンA：左側の機能)
　：独り言モードのＯＮ／ＯＦＦ

独り言モードが ON となります。

http://192.168.0.100/randomSpeak?mode=on


独り言モードが OFF となります。

http://192.168.0.100/randomSpeak?mode=off




〇speakSelfIntro (ボタンC：右側の機能)
　：スタックチャンが自己紹介します。

http://192.168.0.100/speakSelfIntro







------------------------------------------------------------------------

## Ver1.01 2023-04-18

RoboさんのVer007 のソフトをベースにのんちらさんの機能を統合しました。
タイマー機能とLEDピカピカが楽しいです。

独自に次の変更をしています。
・タイマーの時間設定ができる。
・外部からタイマー起動/停止ができる。
・独り言開始ボタンと被らないように、
 タイマー開始/停止ボタンは、A(左)からB(中央)に移動。
 「独り言」中にも、タイマーは有効です。

M5Stack Core2 for AWS 専用のソフト

### 使用方法

-------------------------------------

外部インターフェースについて記載します。

〇timer

　：タイマーの時間設定できます。

30秒から60分未満で秒単位の値を指定してください。
setTime= 30 - 3599(単位：秒)   

http://192.168.0.100/timer?setTime=40


setTimeを指定しないと初期値(=180秒)にタイマーの時間を戻します。

http://192.168.0.100/timer



〇timerGo 　(ボタンＢ：中央の機能)

　：タイマーの開始と時間設定が同時にできます。

タイマーの時間設定して、タイマーを開始します。
時間設定は、上記のtimerコマンドと同じく、30秒から60分未満で秒単位の値を指定してください。

http://192.168.0.100/timerGo?setTime=90


setTimeを指定しないと、事前の設定値でタイマーが開始します。

http://192.168.0.100/timerGo



〇timerStop 　(ボタンＢ：中央の機能)

　：実行中のタイマーを停止ます。

http://192.168.0.100/timerStop



〇version

　：ソフトウエアのバージョン情報を出力します。

http://192.168.0.100/version

  -> AiStackChanEx Ver1.01 2023-04-18
